name: Check

on: [pull_request, push]

permissions:
  issues: write
  contents: read

jobs:
  check-all:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史记录以检查提交消息

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run comprehensive checks
        id: check
        run: |
          echo "Running comprehensive checks..."
          python .github/scripts/check.py
        continue-on-error: false

      - name: Generate check report
        if: failure()
        run: |
          # 创建检查报告
          echo "# Check Report" > check_report.md
          echo "" >> check_report.md
          echo "Checks failed for commit ${{ github.sha }}" >> check_report.md
          echo "" >> check_report.md
          echo "See workflow logs for details." >> check_report.md

      - name: Upload check report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: check-report
          path: check_report.md

  handle-failure:
    runs-on: ubuntu-latest
    needs: check-all
    if: failure()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download check report
        uses: actions/download-artifact@v4
        with:
          name: check-report
          path: .
      - name: Get commit information
        id: commit_info
        run: |
          echo "short_sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          commit_message=$(git log --format=%B -n 1 ${{ github.sha }})
          echo "commit_message<<EOF" >> $GITHUB_OUTPUT
          echo "$commit_message" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Check for existing issue
        id: check_issue
        run: |
          issue_count=$(gh issue list --repo ${{ github.repository }} --label "bug" --search "\"\${{ steps.commit_info.outputs.short_sha }} 检查失败\" in:title" | wc -l)
          if [ $issue_count -gt 0 ]; then
            echo "issue_exists=true" >> $GITHUB_OUTPUT
          else
            echo "issue_exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create issue with report
        if: steps.check_issue.outputs.issue_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_MESSAGE: ${{ steps.commit_info.outputs.commit_message }}
          SHORT_SHA: ${{ steps.commit_info.outputs.short_sha }}
          HEAD_SHA: ${{ github.sha }}
          REPO: ${{ github.repository }}
          SERVER_URL: ${{ github.server_url }}
        run: |
          cat <<EOF > issue-body.md
          在 commit [$SHORT_SHA]($SERVER_URL/$REPO/commit/$HEAD_SHA) 中检查失败。

          **Commit Message:**
          $COMMIT_MESSAGE

          ---

          EOF
          if [ -f check_report.md ]; then
            cat check_report.md >> issue-body.md
          else
            echo "检查失败，请查看工作流日志获取详细信息。" >> issue-body.md
          fi
          gh issue create --repo $REPO --title "$SHORT_SHA 检查失败" --body-file issue-body.md --label "bug"
