name: opencode

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  opencode:
    if: >
      contains(github.event.comment.body, ' /oc') ||
      startsWith(github.event.comment.body, '/oc') ||
      contains(github.event.comment.body, ' /opencode') ||
      startsWith(github.event.comment.body, '/opencode') ||
      (github.event_name == 'pull_request_review_comment' &&
       startsWith(github.event.pull_request.head.ref, 'opencode/')) ||
      (github.event_name == 'pull_request_review' &&
       github.event.review.state == 'changes_requested' &&
       startsWith(github.event.pull_request.head.ref, 'opencode/'))
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: read

    steps:
      # 1️⃣ 解析 /oc branch=xxx
      - name: Parse branch override
        id: parse_branch
        run: |
          BODY="${{ github.event.comment.body }}"
          BRANCH=""
          PART=$(echo "$BODY" | sed -n 's/.*branch=\([^[:space:]]*\).*/\1/p')
          if [ -n "$PART" ]; then
            BRANCH="$PART"
          fi
          echo "override_branch=$BRANCH" >> $GITHUB_OUTPUT

      # 2️⃣ 决定最终 checkout 的分支
      - name: Determine source branch
        id: src
        run: |
          if [ "${{ steps.parse_branch.outputs.override_branch }}" != "" ]; then
            echo "source_branch=${{ steps.parse_branch.outputs.override_branch }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "${{ github.event.issue.pull_request.url }}" != "" ]; then
            echo "source_branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "source_branch=${{ github.event.repository.default_branch }}" >> $GITHUB_OUTPUT

      # 3️⃣ Checkout 源分支
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.src.outputs.source_branch }}
          persist-credentials: false

      # 4️⃣ 记录“原分支”
      - name: Record source branch
        id: src_branch
        run: |
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "source_branch=$BRANCH" >> $GITHUB_OUTPUT

      # 5️⃣ Run opencode
      - name: Run opencode
        uses: anomalyco/opencode/github@latest
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        with:
          model: deepseek/deepseek-reasoner

      # 6️⃣ 记录 OC 创建的新分支
      - name: Detect opencode branch
        id: oc_branch
        run: |
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "oc_branch=$BRANCH" >> $GITHUB_OUTPUT

      # 7️⃣ 查找由 OC 创建的 PR
      - name: Find PR created by opencode
        id: find_pr
        run: |
          BRANCH="${{ steps.oc_branch.outputs.oc_branch }}"
          PR=$(gh pr list \
            --head "$BRANCH" \
            --state open \
            --json number \
            --jq '.[0].number')
          echo "pr_number=$PR" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 8️⃣ 修正 PR base（如果是普通 PR）
      - name: Fix PR base
        if: steps.find_pr.outputs.pr_number != '' &&
            !startsWith(steps.src_branch.outputs.source_branch, 'opencode/')
        run: |
          gh pr edit ${{ steps.find_pr.outputs.pr_number }} \
            --base "${{ steps.src_branch.outputs.source_branch }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 9️⃣ opencode → opencode：fast‑forward 合并 + 删除新 PR + 转发描述
      - name: Fast-forward merge new opencode branch into previous opencode branch
        if: >
          steps.find_pr.outputs.pr_number != '' &&
          startsWith(steps.src_branch.outputs.source_branch, 'opencode/')
        run: |
          NEW_PR=${{ steps.find_pr.outputs.pr_number }}
          NEW_BRANCH=${{ steps.oc_branch.outputs.oc_branch }}
          OLD_BRANCH=${{ steps.src_branch.outputs.source_branch }}

          # 获取旧 PR 号（issue_comment 和 review 事件字段不同）
          OLD_PR="${{ github.event.issue.number }}"
          if [ -z "$OLD_PR" ]; then
            OLD_PR="${{ github.event.pull_request.number }}"
          fi

          echo "Old PR: #$OLD_PR (branch: $OLD_BRANCH)"
          echo "New PR: #$NEW_PR (branch: $NEW_BRANCH)"

          git fetch origin "$OLD_BRANCH" "$NEW_BRANCH"

          git checkout "$OLD_BRANCH"

          echo "Attempting fast-forward merge..."
          if git merge --ff-only "origin/$NEW_BRANCH"; then
            echo "Fast-forward merge succeeded, pushing..."
            git push origin "$OLD_BRANCH"
          else
            echo "Fast-forward merge failed, skipping cleanup."
            exit 0
          fi

          echo "Fetching new PR body..."
          BODY=$(gh pr view "$NEW_PR" --json body --jq .body)

          if [ -n "$BODY" ]; then
            echo "Posting new PR body to old PR #$OLD_PR"
            gh pr comment "$OLD_PR" --body "$BODY"
          fi

          echo "Closing new PR and deleting branch..."
          gh pr close "$NEW_PR" --delete-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}